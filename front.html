<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>LinkTradeNetwork • Skilled Trades</title>
<style>
:root{
  --bg:#f0f4f8;--ink:#293241;--muted:#5d7290;--line:#cfd9e6;--panel:#ffffff;--panel2:#f8fafc;
  --brand:#ea6a00;--brand2:#c35700;--accent:#3d5a80
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:'Poppins',system-ui,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5}
.topbar{background:var(--accent);border-bottom:1px solid var(--line);position:sticky;top:0;z-index:10;color:white}
.topbar-inner{max-width:1200px;margin:auto;padding:12px 16px;display:flex;align-items:center;gap:16px;justify-content:space-between;flex-wrap:wrap}
.logo{display:flex;align-items:center;gap:12px}
.logo-badge{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,#ff7e00,#ffaa00);display:grid;place-items:center;color:white;font-weight:800;font-size:18px;box-shadow:0 2px 5px rgba(0,0,0,.2)}
.logo-text{font-size:18px;font-weight:700}
.nav{display:flex;align-items:center;gap:8px}
.nav a,.btn{color:white;text-decoration:none;font-weight:600;padding:8px 16px;border-radius:8px;font-size:15px;transition:all .2s}
.nav a:hover{background:rgba(255,255,255,.1)}
.btn{cursor:pointer;border:none}
.btn-primary{background:var(--brand);color:white;font-weight:600}
.btn-primary:hover{background:var(--brand2);transform:translateY(-2px);box-shadow:0 2px 5px rgba(0,0,0,.1)}
.btn-secondary{background:rgba(255,255,255,.15);backdrop-filter:blur(10px)}
.btn-secondary:hover{background:rgba(255,255,255,.25)}
.shell{max-width:1200px;margin:auto;padding:24px;display:grid;gap:24px;grid-template-columns:300px 1fr 320px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,.05);overflow:hidden;transition:transform .2s}
.card:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(0,0,0,.08)}
.card .hd{padding:16px 20px;font-weight:700;border-bottom:1px solid var(--line);background:var(--panel2);font-size:16px;display:flex;justify-content:space-between;align-items:center}
.card .bd{padding:20px}
.profile-placeholder{width:100%;height:150px;border-radius:12px;background:var(--panel2);margin-bottom:16px;display:flex;flex-direction:column;align-items:center;justify-content:center;border:2px dashed var(--line);color:var(--muted)}
.profile-placeholder svg{width:40px;height:40px;margin-bottom:8px;opacity:.5}
.profile-info{text-align:center;margin:15px 0}
.small{font-size:14px;color:var(--muted)}
.section-title{font-weight:700;margin-bottom:12px;font-size:16px;color:var(--accent)}
.filters{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}
.fbtn{padding:8px 16px;border:1px solid var(--line);border-radius:999px;background:var(--panel);color:var(--muted);font-size:13px;cursor:pointer;transition:all .2s;font-weight:500}
.fbtn:hover{border-color:var(--brand);color:var(--brand)}
.fbtn.active{background:var(--brand);color:white;border-color:var(--brand)}
.jobs-container{display:flex;flex-direction:column;gap:16px}
.job{padding:16px;border:1px solid var(--line);border-radius:12px;transition:all .2s;background:var(--panel)}
.job:hover{border-color:var(--brand);box-shadow:0 4px 12px rgba(0,0,0,.08)}
.job .title{font-weight:700;font-size:17px;margin-bottom:6px}
.job .meta{font-size:14px;color:var(--muted);display:flex;align-items:center;gap:8px;margin-bottom:10px}
.meta-dot{display:inline-block;width:4px;height:4px;background:var(--muted);border-radius:50%}
.tags{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px}
.tag{background:var(--panel2);border:1px solid var(--line);border-radius:6px;padding:4px 10px;font-size:12px;font-weight:500;color:var(--accent)}
.apply{display:flex;gap:10px;flex-wrap:wrap}
.featured{background:#fff9e6;border-left:4px solid #ffc107}
.upload-area{border:2px dashed var(--line);border-radius:8px;padding:20px;text-align:center;cursor:pointer;margin-bottom:20px;transition:all .2s}
.upload-area:hover{border-color:var(--brand);background:rgba(234,106,0,.05)}
.upload-icon{display:block;width:40px;height:40px;margin:0 auto 10px;opacity:.5}
.form-group{margin-bottom:15px}
.form-group label{display:block;margin-bottom:5px;font-weight:500;font-size:14px}
.form-control{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:8px;background:var(--panel);font-family:inherit;font-size:14px;color:var(--ink)}
.form-control:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 2px rgba(234,106,0,.1)}
textarea.form-control{min-height:100px;resize:vertical}
.badge{display:inline-block;padding:3px 8px;font-size:12px;font-weight:600;border-radius:999px;background:#e6f5eb;color:#2a9d51}
.badge-warning{background:#fff9e6;color:#b37400}
.stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin:15px 0}
.stat-card{background:var(--panel2);border:1px solid var(--line);border-radius:8px;padding:12px;text-align:center}
.stat-number{font-size:24px;font-weight:700;color:var(--accent)}
.stat-label{font-size:13px;color:var(--muted)}
.search-container{flex-grow:1;max-width:400px;margin:0 10px;position:relative}

/* AI Search styles */
.ai-results{padding:12px;color:var(--ink)}
.ai-thinking{display:flex;align-items:center;gap:8px;padding:10px;color:var(--muted)}
.ai-thinking-dots{display:flex}
.ai-thinking-dots span{width:6px;height:6px;margin:0 2px;background:var(--brand);border-radius:50%;animation:ai-thinking 1.4s infinite ease-in-out both}
.ai-thinking-dots span:nth-child(1){animation-delay:-.32s}
.ai-thinking-dots span:nth-child(2){animation-delay:-.16s}
@keyframes ai-thinking{0%,80%,100%{transform:scale(0)}40%{transform:scale(1.0)}}
.ai-result{padding:12px;border-bottom:1px solid var(--line)}
.ai-result:last-child{border-bottom:none}
.ai-result-title{font-weight:600;margin-bottom:4px}

@media(max-width:1100px){.shell{grid-template-columns:1fr 1fr}.right-sidebar{grid-column:span 2}}
@media(max-width:768px){.shell{grid-template-columns:1fr}.right-sidebar{grid-column:span 1}.nav{margin-top:10px}.search-container{max-width:100%;margin-bottom:10px}}
</style>
</head>
<body>

<header class="topbar">
  <div class="topbar-inner">
    <div class="logo">
      <div class="logo-badge">LTN</div>
      <div class="logo-text">LinkTradeNetwork</div>
    </div>

    <div class="search-container">
      <div class="ai-search-wrapper" style="position:relative;">
        <input type="text" id="ai-search-input" class="form-control" placeholder="Ask LTN AI anything..." style="background:rgba(255,255,255,.15);border:none;color:white;padding-left:35px">
        <svg id="ai-icon" style="position:absolute;left:10px;top:10px;width:18px;height:18px;opacity:.8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="white"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
        <div class="ai-label" style="position:absolute;right:8px;top:10px;font-size:10px;background:var(--brand);color:white;padding:1px 6px;border-radius:10px;opacity:.9;font-weight:600">LTN AI</div>
      </div>
      <div id="ai-results-container" class="ai-results" style="display:none;position:absolute;top:45px;left:0;right:0;background:white;border-radius:8px;box-shadow:0 4px 15px rgba(0,0,0,.15);z-index:100;max-height:400px;overflow-y:auto"></div>
    </div>

    <nav class="nav">
      <a href="#">Home</a>
      <a href="#">Jobs</a>
      <a href="#">Network</a>
      <a href="#">Messages</a>
      <button class="btn btn-primary">Post a Job</button>
      <a href="index.html" class="btn btn-secondary">Logout</a>
    </nav>
  </div>
</header>

<main class="shell">
  <!-- LEFT -->
  <aside>
    <section class="card">
      <div class="hd"><span>Profile</span><span class="badge">Professional</span></div>
      <div class="bd">
        <div class="profile-placeholder" id="profile-image-area">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
          <div>Add profile image</div>
        </div>
        <div class="upload-area" id="profile-upload">
          <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0l-4 4m4-4v12"/></svg>
          <div class="small">Click to upload profile information</div><div class="small">(Resume, certifications, etc.)</div>
          <input type="file" id="file-upload" style="display:none" multiple>
        </div>
        <div class="stats">
          <div class="stat-card"><div class="stat-number">24</div><div class="stat-label">Connections</div></div>
          <div class="stat-card"><div class="stat-number">8</div><div class="stat-label">Applications</div></div>
        </div>
        <p class="small">Complete your profile to improve visibility with contractors and employers.</p>
        <button class="btn-primary" style="width:100%;margin-top:10px">Edit Profile</button>
      </div>
    </section>

    <section class="card" style="margin-top:20px">
      <div class="hd">Job Alerts</div>
      <div class="bd">
        <p class="small">Get notified when new jobs match your skills.</p>
        <div class="form-group"><label>Skills & Trades</label><input type="text" class="form-control" placeholder="e.g. Electrical, Low Voltage"></div>
        <div class="form-group"><label>Location</label><input type="text" class="form-control" placeholder="City, State, or Zip"></div>
        <button class="btn-primary" style="width:100%">Create Alert</button>
      </div>
    </section>
  </aside>

  <!-- MIDDLE -->
  <section>
    <div class="card">
      <div class="hd"><span>Skilled Trade Opportunities</span><span class="badge badge-warning">12 new today</span></div>
      <div class="bd">
        <div class="filters">
          <button class="fbtn active">All</button>
          <button class="fbtn">Low Voltage</button>
          <button class="fbtn">Electrical</button>
          <button class="fbtn">Plumbing</button>
          <button class="fbtn">HVAC</button>
          <button class="fbtn">General Contractor</button>
          <button class="fbtn">Physical Security</button>
          <button class="fbtn">Sprinkler</button>
        </div>

        <div class="jobs-container">
          <article class="job featured">
            <div class="title">Low Voltage Cable Installer – Hospital Retrofit</div>
            <div class="meta">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 13C13.6569 13 15 11.6569 15 10C15 8.34315 13.6569 7 12 7C10.3431 7 9 8.34315 9 10C9 11.6569 10.3431 13 12 13Z" stroke="currentColor"/><path d="M19 10C19 14.4183 12 20 12 20C12 20 5 14.4183 5 10C5 6.13401 8.13401 3 12 3C15.866 3 19 6.13401 19 10Z" stroke="currentColor"/></svg>
              Madison, WI <span class="meta-dot"></span> Contract <span class="meta-dot"></span> $42–$55/hr
            </div>
            <div class="tags"><span class="tag">Low Voltage</span><span class="tag">Fiber</span><span class="tag">Cabling</span><span class="tag">Experience: 3+ years</span></div>
            <div class="apply"><button class="btn-primary">Apply Now</button><button class="btn-secondary">Save</button></div>
          </article>

          <article class="job">
            <div class="title">Journeyman Electrician – Conduit & Lighting</div>
            <div class="meta">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 13C13.6569 13 15 11.6569 15 10C15 8.34315 13.6569 7 12 7C10.3431 7 9 8.34315 9 10C9 11.6569 10.3431 13 12 13Z" stroke="currentColor"/><path d="M19 10C19 14.4183 12 20 12 20C12 20 5 14.4183 5 10C5 6.13401 8.13401 3 12 3C15.866 3 19 6.13401 19 10Z" stroke="currentColor"/></svg>
              Milwaukee, WI <span class="meta-dot"></span> Full-time <span class="meta-dot"></span> $38–$50/hr
            </div>
            <div class="tags"><span class="tag">Electrical</span><span class="tag">Conduit</span><span class="tag">Licensed</span></div>
            <div class="apply"><button class="btn-primary">Apply Now</button><button class="btn-secondary">Save</button></div>
          </article>

          <article class="job">
            <div class="title">Commercial HVAC Installer – Rooftop Units</div>
            <div class="meta">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 13C13.6569 13 15 11.6569 15 10C15 8.34315 13.6569 7 12 7C10.3431 7 9 8.34315 9 10C9 11.6569 10.3431 13 12 13Z" stroke="currentColor"/><path d="M19 10C19 14.4183 12 20 12 20C12 20 5 14.4183 5 10C5 6.13401 8.13401 3 12 3C15.866 3 19 6.13401 19 10Z" stroke="currentColor"/></svg>
              Sun Prairie, WI <span class="meta-dot"></span> Contract <span class="meta-dot"></span> $36–$48/hr
            </div>
            <div class="tags"><span class="tag">HVAC</span><span class="tag">Controls</span><span class="tag">Experience: 2+ years</span></div>
            <div class="apply"><button class="btn-primary">Apply Now</button><button class="btn-secondary">Save</button></div>
          </article>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:24px">
      <div class="hd">Success Stories</div>
      <div class="bd">
        <div style="display:flex;align-items:center;margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid var(--line)">
          <div style="width:80px;height:80px;background:var(--panel2);border-radius:50%;margin-right:15px;flex-shrink:0;display:flex;align-items:center;justify-content:center">
            <svg style="width:40px;height:40px;opacity:.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
          </div>
          <div>
            <div style="font-weight:700;font-size:16px">Michael Rodriguez - Electrician</div>
            <div style="color:var(--muted);margin-bottom:5px">Milwaukee, WI</div>
            <p style="margin:0">"I found my current position through LinkTradeNetwork within 2 weeks of creating my profile. The job pays 20% more than my previous position and has better hours."</p>
          </div>
        </div>
        <button class="btn-primary" style="width:100%;margin-top:20px">Share Your Success Story</button>
      </div>
    </div>

    <div class="card" style="margin-top:24px">
      <div class="hd">Post a New Job</div>
      <div class="bd">
        <div class="form-group"><label>Job Title</label><input type="text" class="form-control" placeholder="e.g. Experienced Plumber for Commercial Project"></div>
        <div class="form-group"><label>Job Type</label><select class="form-control"><option>Full-time</option><option>Contract</option><option>Part-time</option><option>Project-based</option></select></div>
        <div class="form-group"><label>Location</label><input type="text" class="form-control" placeholder="City, State"></div>
        <div class="form-group"><label>Pay Range</label><div style="display:flex;gap:10px"><input type="text" class="form-control" placeholder="Min $"><input type="text" class="form-control" placeholder="Max $"><select class="form-control"><option>hourly</option><option>daily</option><option>project</option></select></div></div>
        <div class="form-group"><label>Required Skills</label><div class="filters" style="margin-top:5px"><button class="fbtn">Low Voltage</button><button class="fbtn">Electrical</button><button class="fbtn">Plumbing</button><button class="fbtn">HVAC</button><button class="fbtn">General Contractor</button><button class="fbtn">Physical Security</button></div></div>
        <div class="form-group"><label>Job Description</label><textarea class="form-control" placeholder="Describe the job..."></textarea></div>
        <div class="form-group"><label>Upload Supporting Documents (optional)</label><div class="upload-area"><svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg><div class="small">Drag and drop files or click to upload</div></div></div>
        <button class="btn-primary" style="width:100%">Post Job</button>
      </div>
    </div>
  </section>

  <!-- RIGHT -->
  <aside class="right-sidebar">
    <section class="card">
      <div class="hd">Get Connected</div>
      <div class="bd small">
        <p>Join the network built for skilled trades professionals:</p>
        <ul><li>Find verified trade jobs with competitive pay</li><li>Connect with local contractors and employers</li><li>Showcase your skills and certifications</li><li>Get matched with projects in your area</li></ul>
        <button class="btn-primary" style="width:100%">Join Network</button>
      </div>
    </section>

    <section class="card" style="margin-top:20px">
      <div class="hd">Get The LTN Mobile App</div>
      <div class="bd" style="padding:0">
        <div style="background:linear-gradient(135deg,var(--brand),var(--brand2));color:white;padding:20px;text-align:center;border-radius:0 0 12px 12px">
          <svg style="width:60px;height:60px;margin-bottom:10px" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="white"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 01-2 2z"/></svg>
          <h3 style="margin:0 0 10px;font-size:18px">Find Trade Jobs On The Go</h3>
          <p style="margin:0 0 15px">Get instant job alerts, apply with one tap, and chat with employers directly from your phone.</p>
          <button class="btn-secondary" style="display:inline-block;padding:12px 24px;font-size:16px">Get The LTN App</button>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:20px">
      <div class="hd">Upcoming Events</div>
      <div class="bd small">
        <div style="margin-bottom:15px"><div style="font-weight:600">Trade Skills Workshop</div><div>November 15, 2025 • 9:00 AM</div><div style="color:var(--muted)">Milwaukee Convention Center</div></div>
        <div style="margin-bottom:15px"><div style="font-weight:600">Electrical Code Updates</div><div>November 22, 2025 • 1:00 PM</div><div style="color:var(--muted)">Online Webinar</div></div>
        <div><div style="font-weight:600">Contractor Networking Mixer</div><div>December 5, 2025 • 6:00 PM</div><div style="color:var(--muted)">Madison Trade Association</div></div>
        <button class="btn-primary" style="width:100%;margin-top:15px">View All Events</button>
      </div>
    </section>

    <section class="card" style="margin-top:20px">
      <div class="hd">Quick Resources</div>
      <div class="bd small">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <a href="#" style="text-decoration:none"><div style="border:1px solid var(--line);border-radius:8px;padding:12px;text-align:center;color:var(--ink)"><svg style="width:24px;height:24px;margin:0 auto 8px;display:block;opacity:.7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h2l2-2 4-4M7 20h10a2 2 0 002-2V6a2 2 0 00-2-2H7a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg><div>License Info</div></div></a>
          <a href="#" style="text-decoration:none"><div style="border:1px solid var(--line);border-radius:8px;padding:12px;text-align:center;color:var(--ink)"><svg style="width:24px;height:24px;margin:0 auto 8px;display:block;opacity:.7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg><div>Training</div></div></a>
          <a href="#" style="text-decoration:none"><div style="border:1px solid var(--line);border-radius:8px;padding:12px;text-align:center;color:var(--ink)"><svg style="width:24px;height:24px;margin:0 auto 8px;display:block;opacity:.7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg><div>Certifications</div></div></a>
          <a href="#" style="text-decoration:none"><div style="border:1px solid var(--line);border-radius:8px;padding:12px;text-align:center;color:var(--ink)"><svg style="width:24px;height:24px;margin:0 auto 8px;display:block;opacity:.7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9"/></svg><div>Support</div></div></a>
        </div>
      </div>
    </section>
  </aside>
</main>

<script>
/* ===== CONFIG: set your Apps Script Web App URL (the /exec URL) ===== */
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzVSFBDBpxaAljquQ0gB2Ih3OGlGJY1kRPgwobHMgFk-2xpKQm1EMpBwEUH0nbzdwe1/exec";

/* ===== Utility ===== */
function debounce(fn, ms){let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn.apply(this,a),ms)}}
const isHtmlResponse = (res) => {
  const ct = res.headers.get('content-type') || '';
  return ct.includes('text/html');
};

/* ===== Filter buttons behavior ===== */
document.addEventListener('DOMContentLoaded', function() {
  const filterGroups = document.querySelectorAll('.filters');
  filterGroups.forEach(group => {
    const buttons = group.querySelectorAll('.fbtn');
    buttons.forEach(b => b.addEventListener('click', () => {
      if (!group.parentElement.classList.contains('form-group')) {
        buttons.forEach(x => x.classList.remove('active'));
        b.classList.add('active');
      } else {
        b.classList.toggle('active');
      }
    }));
  });

  document.getElementById('profile-upload').addEventListener('click', () => {
    document.getElementById('file-upload').click();
  });

  /* ===== LTN AI Search (diagnostics + robust handling) ===== */
  const input = document.getElementById('ai-search-input');
  const box   = document.getElementById('ai-results-container');

  function thinking(){ box.style.display='block'; box.innerHTML =
    `<div class="ai-thinking">
      <svg style="width:20px;height:20px" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
      </svg>
      <span>LTN AI is thinking</span>
      <div class="ai-thinking-dots"><span></span><span></span><span></span></div>
    </div>`; }

  function friendlyFallback(query, reason){
    box.style.display='block';
    box.innerHTML = `
      <div class="ai-result">
        <div class="ai-result-title">LTN AI is temporarily unavailable</div>
        <p class="small" style="color:var(--muted)">${reason}</p>
        <p>Here are some quick ideas related to "<b>${query.replace(/</g,'&lt;')}</b>":</p>
        <ul style="margin:0 0 8px 18px">
          <li>Check local licensing requirements and apprenticeship paths.</li>
          <li>Look up prevailing wages for your county and trade.</li>
          <li>Search for nearby union halls or training centers.</li>
        </ul>
        <p class="small" style="color:var(--muted)">Try again in a moment.</p>
      </div>`;
  }

  async function pingExec(){
    try{
      const r = await fetch(WEBAPP_URL, { method:'GET' });
      if (!r.ok) return { ok:false, code:r.status, html:isHtmlResponse(r) };
      if (isHtmlResponse(r)) return { ok:false, code:200, html:true };
      const j = await r.json().catch(()=>null);
      return { ok: !!j, code:r.status, html:false, body:j };
    }catch(e){
      return { ok:false, code:'NETWORK', html:false, error:String(e) };
    }
  }

  async function aiSearch(query){
    if (!query.trim()){ box.style.display='none'; return; }
    thinking();

    // quick ping: if your web app isn't public, Google returns HTML login
    const ping = await pingExec();
    if (!ping.ok){
      const diag = ping.html
        ? "Your Apps Script Web App is not public. In Apps Script: Manage deployments → Web app → Who has access = Anyone. Use the /exec URL."
        : `The Web App is unreachable (status: ${ping.code}).`;
      friendlyFallback(query, diag);
      return;
    }

    const controller = new AbortController();
    const t = setTimeout(()=>controller.abort(), 15000);

    try{
      const email = localStorage.getItem('userEmail') || '';
      const res = await fetch(WEBAPP_URL, {
        method:'POST',
        headers:{ 'Content-Type':'text/plain;charset=utf-8' }, // avoid CORS preflight with GAS
        body: JSON.stringify({ action:'ai-search', query, email }),
        signal: controller.signal
      });
      clearTimeout(t);

      // If GAS returns HTML (e.g., not-public), catch it early:
      const ct = res.headers.get('content-type') || '';
      if (ct.includes('text/html')){
        friendlyFallback(query, "Apps Script returned HTML (likely not public). Set access to Anyone and use the /exec URL.");
        return;
      }

      if (!res.ok){
        friendlyFallback(query, `Backend returned HTTP ${res.status}.`);
        return;
      }

      const data = await res.json();
      if (!data.success){
        // Show backend reason (often "Error connecting to AI service...")
        friendlyFallback(query, data.error || "Unknown backend error.");
        return;
      }

      const ai = data.response || {};
      const title = ai.title || `Results for "${query}"`;
      const content = ai.content || 'No results found.';
      let html = `<div class="ai-result"><div class="ai-result-title">${title}</div><p>${content}</p></div>`;
      box.style.display='block';
      box.innerHTML = html;

    }catch(err){
      clearTimeout(t);
      const msg = (err.name === 'AbortError') ? 'Request timed out.' : (err.message || 'Network error.');
      friendlyFallback(query, msg);
      console.error('AI search error:', err);
    }
  }

  const debounced = debounce(q=>aiSearch(q), 500);
  input.addEventListener('input', function(){ debounced(this.value); });
  input.addEventListener('focus', function(){ if (this.value.trim()) aiSearch(this.value); });
  input.addEventListener('keydown', e=>{ if (e.key==='Enter' && input.value.trim()) aiSearch(input.value); });

  document.addEventListener('click', e=>{
    if (!input.contains(e.target) && !box.contains(e.target)) box.style.display='none';
  });

  // Helper to store email post-login
  window.storeUserEmail = function(email){
    if (email && typeof email === 'string') localStorage.setItem('userEmail', email);
  };
});
</script>

</body>
</html>
