<script>
// ========= CONFIG =========
const APPS_SCRIPT_URL =
  'https://script.google.com/macros/s/AKfycbwZEsZ1IYeqPxPmhLxI5EhhEIImy5qeZwA4oOjRa7UQ3Ctr9CQhnarY7tfmgRSeUOIY/exec';

// ========= CORE API (no custom headers -> no CORS preflight) =========
async function postJSON(data) {
  try {
    const res = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify(data),
      redirect: 'follow'
    });
    const text = await res.text();
    try { return JSON.parse(text); } catch { return { success:false, error:text }; }
  } catch (err) {
    console.error('API Error:', err);
    return { success:false, error:String(err && err.message || err) };
  }
}

// Convenience wrappers if you want to call from other pages too
function signup({ name, email, consent, userAgent }) {
  return postJSON({ action: 'signup', name, email, consent, userAgent });
}
function verify({ email, code }) {
  return postJSON({ action: 'verify', email, code });
}
function resend({ email, name }) {
  return postJSON({ action: 'resend', email, name });
}

// ========= DOM HOOKS =========
const $  = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

const joinBtn   = $('#joinBtn');
const joinMsg   = $('#joinMsg');
const otpBox    = $('#otpStep');
const otpMsg    = $('#otpMsg');
const otpEmail  = $('#otpEmail');
const verifyBtn = $('#verifyBtn');
const resendBtn = $('#resendBtn');

const firstNameInput = $('#firstName');
const lastNameInput  = $('#lastName');
const emailInput     = $('#email');
const consent        = $('#consent');

const codeInputs = $$('#otpStep input');

let currentEmail = '';
let currentFirst = '';
let currentLast  = '';

function getCode() { return codeInputs.map(i => i.value).join(''); }

// Auto-advance OTP boxes & digits only
codeInputs.forEach((inp, i) => {
  inp.addEventListener('input', () => {
    inp.value = inp.value.replace(/\D/g,'');
    if (inp.value && i < codeInputs.length - 1) codeInputs[i + 1].focus();
  });
  inp.addEventListener('keydown', (e) => {
    if (e.key === 'Backspace' && !inp.value && i > 0) codeInputs[i - 1].focus();
  });
});

// ========= HANDLERS =========
joinBtn?.addEventListener('click', async () => {
  const first = (firstNameInput?.value || '').trim();
  const last  = (lastNameInput?.value || '').trim();
  const email = (emailInput?.value || '').trim().toLowerCase();

  if (!first || !last || !email) {
    joinMsg.textContent = 'First name, last name, and email required';
    joinMsg.className = 'msg err';
    return;
  }
  if (!consent?.checked) {
    joinMsg.textContent = 'Please agree to the Terms.';
    joinMsg.className = 'msg err';
    return;
  }

  joinBtn.disabled = true;
  joinMsg.textContent = 'Checking…';
  joinMsg.className = 'msg ok';

  try {
    const name = `${first} ${last}`;
    const r = await signup({
      name,
      email,
      consent: true,
      userAgent: navigator.userAgent
    });

    // If already verified → skip OTP & sign in
    if (r && r.success && r.verified && r.requiresOtp === false) {
      localStorage.setItem('ltn_user', JSON.stringify({ firstName:first, lastName:last, name, email }));
      window.location.replace('/front.html');
      return;
    }

    // Otherwise show OTP step
    if (r && r.success) {
      currentEmail = email; currentFirst = first; currentLast = last;
      otpEmail.textContent = email;
      $('#joinStep').style.display = 'none';
      otpBox.style.display = 'block';
      codeInputs[0].focus();
      joinMsg.textContent = '';
      return;
    }

    throw new Error((r && r.error) || 'Failed to start sign-in');
  } catch (err) {
    joinMsg.textContent = String(err && err.message || err);
    joinMsg.className = 'msg err';
  } finally {
    joinBtn.disabled = false;
  }
});

verifyBtn?.addEventListener('click', async () => {
  const code = getCode();
  if (code.length !== 6) {
    otpMsg.textContent = 'Enter full 6-digit code';
    otpMsg.className = 'msg err';
    return;
  }

  verifyBtn.disabled = true;
  otpMsg.textContent = 'Verifying…';
  otpMsg.className = 'msg ok';

  try {
    const r = await verify({ email: currentEmail, code });
    if (r && r.success) {
      localStorage.setItem('ltn_user', JSON.stringify({
        firstName: currentFirst,
        lastName:  currentLast,
        name: `${currentFirst} ${currentLast}`,
        email: currentEmail
      }));
      otpBox.style.display = 'none';
      $('#doneStep').style.display = 'block';
      setTimeout(() => window.location.replace('/front.html'), 900);
      return;
    }
    throw new Error((r && r.error) || 'Verification failed');
  } catch (err) {
    otpMsg.textContent = String(err && err.message || err);
    otpMsg.className = 'msg err';
  } finally {
    verifyBtn.disabled = false;
  }
});

resendBtn?.addEventListener('click', async () => {
  resendBtn.disabled = true;
  try {
    const r = await resend({ email: currentEmail, name: `${currentFirst} ${currentLast}` });
    otpMsg.textContent = (r && r.success) ? 'New code sent!' : (r && r.error) || 'Resend failed';
    otpMsg.className = 'msg ' + ((r && r.success) ? 'ok' : 'err');
  } catch (err) {
    otpMsg.textContent = String(err && err.message || err);
    otpMsg.className = 'msg err';
  } finally {
    setTimeout(() => (resendBtn.disabled = false), 3000);
  }
});
</script>
