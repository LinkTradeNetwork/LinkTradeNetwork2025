<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LinkTradeNetwork • Sign In</title>
<style>
  :root{--bg1:#667eea;--bg2:#764ba2;--panel:#fff;--ink:#1e293b;--muted:#64748b;--line:#e2e8f0;--brand:#ea6a00;--ok:#22c55e;--err:#ef4444;--accent:#0ea5e9}
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;background:linear-gradient(135deg,var(--bg1),var(--bg2));font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:var(--ink)}
  .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;flex-direction:column;gap:14px}
  .banner{background:#10b981;color:#062; padding:6px 12px;border-radius:999px;font-weight:800}
  .card{width:min(440px,92vw);background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);padding:24px}
  h1{text-align:center;margin:0 0 6px}
  .sub{text-align:center;color:var(--muted);margin:0 0 16px}
  label{display:block;margin-top:10px;font-size:14px}
  input{width:100%;margin-top:6px;background:#f8fafc;border:2px solid var(--line);border-radius:10px;padding:12px;font-size:14px}
  input:focus{outline:none;border-color:var(--accent);background:#fff;box-shadow:0 0 0 3px rgba(14,165,233,.12)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .agree{display:flex;gap:8px;align-items:center;margin-top:12px;font-size:13px}
  button{width:100%;margin-top:14px;background:var(--brand);color:#fff;border:0;border-radius:10px;padding:12px;font-weight:800;cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed}
  .msg{margin-top:12px;font-size:13px;padding:8px 10px;border-radius:8px}
  .ok{background:#f0fdf4;border:1px solid #bbf7d0;color:#14532d}
  .err{background:#fef2f2;border:1px solid #fecaca;color:#7f1d1d}
  /* OTP step */
  .otp{display:none;margin-top:10px}
  .otp .inputs{display:flex;gap:8px;justify-content:center;margin:10px 0}
  .otp .inputs input{width:44px;height:52px;text-align:center;font-size:22px;font-weight:800}
  #resendBtn{background:#64748b}
  #debug{white-space:pre-wrap;color:#111;background:#fff3;border-radius:8px;padding:10px;font:12px/1.4 ui-monospace,Menlo,Consolas,monospace;max-width:820px}
</style>
</head>
<body>
<div class="wrap">
  <div class="banner">✅ Page Loaded OK</div>

  <div id="debug" style="display:none"></div>

  <div class="card">
    <h1>Sign In</h1>
    <p class="sub">First time? We’ll email you a 6-digit code once. After that, instant sign-in.</p>

    <div id="joinStep">
      <div class="row">
        <div><label>First Name</label><input id="firstName" placeholder="John"></div>
        <div><label>Last Name</label><input id="lastName" placeholder="Doe"></div>
      </div>
      <label>Email</label><input id="email" type="email" placeholder="you@example.com">
      <label class="agree"><input id="consent" type="checkbox"> I agree to the <a href="/terms.html" target="_blank">Terms</a>.</label>
      <button id="joinBtn">Continue</button>
      <div id="joinMsg" class="msg" aria-live="polite"></div>
    </div>

    <div id="otpStep" class="otp">
      <div>Enter the 6-digit code sent to <b id="otpEmail"></b></div>
      <div class="inputs"><input maxlength="1"><input maxlength="1"><input maxlength="1"><input maxlength="1"><input maxlength="1"><input maxlength="1"></div>
      <button id="verifyBtn">Verify</button>
      <button id="resendBtn">Resend Code</button>
      <div id="otpMsg" class="msg" aria-live="polite"></div>
    </div>

    <div id="doneStep" class="msg ok" style="display:none">✅ Verified — redirecting…</div>
  </div>
</div>

<script>
// Show JS errors on the page (helps when the screen looks blank)
(function(){
  const dbg = document.getElementById('debug');
  window.addEventListener('error', e => { dbg.style.display='block'; dbg.textContent = '[JS Error] ' + e.message; });
  window.addEventListener('unhandledrejection', e => { dbg.style.display='block'; dbg.textContent = '[Promise Rejection] ' + (e.reason && e.reason.message || e.reason); });
})();

// ===== CONFIG (your live /exec URL) =====
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwZEsZ1IYeqPxPmhLxI5EhhEIImy5qeZwA4oOjRa7UQ3Ctr9CQhnarY7tfmgRSeUOIY/exec';

// No custom headers => avoids CORS preflight on Apps Script
async function postJSON(data){
  const res = await fetch(APPS_SCRIPT_URL, { method:'POST', body: JSON.stringify(data), redirect:'follow' });
  const text = await res.text();
  try { return JSON.parse(text); } catch { return { success:false, error:text }; }
}

const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const joinBtn=$('#joinBtn'), joinMsg=$('#joinMsg');
const otpBox=$('#otpStep'), otpMsg=$('#otpMsg'), otpEmail=$('#otpEmail');
const verifyBtn=$('#verifyBtn'), resendBtn=$('#resendBtn');
const firstNameInput=$('#firstName'), lastNameInput=$('#lastName'), emailInput=$('#email'), consent=$('#consent');
const codeInputs=$$('#otpStep .inputs input');
let currentEmail='', currentFirst='', currentLast='';

function getCode(){ return codeInputs.map(i=>i.value).join(''); }
codeInputs.forEach((inp,i)=>{
  inp.addEventListener('input',()=>{ inp.value=inp.value.replace(/\D/g,''); if(inp.value && i<5) codeInputs[i+1].focus();});
  inp.addEventListener('keydown',e=>{ if(e.key==='Backspace' && !inp.value && i>0) codeInputs[i-1].focus(); });
});

joinBtn.addEventListener('click', async ()=>{
  const first=(firstNameInput.value||'').trim(), last=(lastNameInput.value||'').trim(), email=(emailInput.value||'').trim().toLowerCase();
  if(!first||!last||!email){ joinMsg.textContent='First name, last name, and email required'; joinMsg.className='msg err'; return; }
  if(!consent.checked){ joinMsg.textContent='Please agree to the Terms.'; joinMsg.className='msg err'; return; }

  joinBtn.disabled=true; joinMsg.textContent='Checking…'; joinMsg.className='msg ok';
  try{
    const r = await postJSON({ action:'signup', name:`${first} ${last}`, email, consent:true, userAgent:navigator.userAgent });

    // Already verified → skip OTP
    if(r && r.success && r.verified && r.requiresOtp===false){
      localStorage.setItem('ltn_user', JSON.stringify({ firstName:first, lastName:last, name:`${first} ${last}`, email }));
      location.replace('/front.html'); return;
    }
    if(r && r.success){
      currentEmail=email; currentFirst=first; currentLast=last;
      otpEmail.textContent=email; document.getElementById('joinStep').style.display='none'; otpBox.style.display='block'; codeInputs[0].focus(); joinMsg.textContent='';
      return;
    }
    throw new Error((r && r.error) || 'Failed to start sign-in');
  }catch(err){
    joinMsg.textContent=String(err && err.message || err); joinMsg.className='msg err';
  }finally{ joinBtn.disabled=false; }
});

verifyBtn.addEventListener('click', async ()=>{
  const c=getCode(); if(c.length!==6){ otpMsg.textContent='Enter full 6-digit code'; otpMsg.className='msg err'; return; }
  verifyBtn.disabled=true; otpMsg.textContent='Verifying…'; otpMsg.className='msg ok';
  try{
    const r=await postJSON({ action:'verify', email:currentEmail, code:c });
    if(r && r.success){
      localStorage.setItem('ltn_user', JSON.stringify({ firstName:currentFirst, lastName:currentLast, name:`${currentFirst} ${currentLast}`, email:currentEmail }));
      otpBox.style.display='none'; document.getElementById('doneStep').style.display='block';
      setTimeout(()=>location.replace('/front.html'), 900); return;
    }
    throw new Error((r && r.error) || 'Verification failed');
  }catch(err){
    otpMsg.textContent=String(err && err.message || err); otpMsg.className='msg err';
  }finally{ verifyBtn.disabled=false; }
});

resendBtn.addEventListener('click', async ()=>{
  resendBtn.disabled=true;
  try{
    const r=await postJSON({ action:'resend', email:currentEmail, name:`${currentFirst} ${currentLast}` });
    otpMsg.textContent = (r && r.success) ? 'New code sent!' : (r && r.error) || 'Resend failed';
    otpMsg.className = 'msg ' + ((r && r.success)?'ok':'err');
  }catch(err){
    otpMsg.textContent=String(err && err.message || err); otpMsg.className='msg err';
  }finally{
    setTimeout(()=>resendBtn.disabled=false, 3000);
  }
});
</script>
</body>
</html>

